#! /bin/sh

######################################################################
#
# VIEW_METROLOC_0.SH
# 列車接近情報を表示(一般仕様)
# Written by Rich Mikan(richmikan@richlab.org) at 2014/09/16
#
# [入力]
# ・引数で下記を指定
#     $1 : 今見たい駅の駅ナンバー
#     $2 : 行先を指示するための駅ナンバー(同じ路線であること)
# ・下記のファイルを用意しておく
#    1. CONF/ACCESSTOKEN.TXT
#       コンテストで与えられたアクセストークンを記述したテキスト
#    2. DATA/SNUM2RWSN_MST.TXT
#       駅ナンバーから路線名や駅名等を引くマスターファイル
#    3. DATA/METRO_VOC_MST.TXT
#       その他(種別・行先名・車両所有業者名等)のボキャブラリーマスターファイル
#    ※ 2,3のファイルはMK_METRO_MST.SHを実行すると得られる。
# [出力]
# ・列車接近情報を標準出力に出す
# ・フォーマットは次のとおり
#   1:自位置インデックス 2:駅ナンバー(駅間の場合は"|")+駅名(駅間の場合は"-")
#   3:列車情報(種別名+目的駅名+車両所有業者名)
#
# [備考]
# ・要curlコマンド
# ・以下の路線は、分岐があるため正常に表示されない。(見ればわかるレベル)
#   - 千代田線(綾瀬から北綾瀬支線への分岐)
#   - 副都心線・有楽町線(小竹向原で西武有楽町線への分岐)
#   - 南北線(白金高輪から都営三田線への分岐)
#   - 丸ノ内線(中野坂上から方南町支線への分岐)
#
######################################################################


######################################################################
# 初期設定
######################################################################

# --- 使用法表示関数定義 ---------------------------------------------
print_usage_and_exit() {
  local s
  s=$(awk 'BEGIN{printf("%070d",0)}' | tr 0 '#')
  awk "f==1&&/^${s}\$/{print;exit} f==0&&/^${s}\$/{f=1} f==1{print;}" "$0" 1>&2
  exit 1
}

# --- このシステムのホームディレクトリー -----------------------------
Homedir="$(d=${0%/*}/; [ "_$d" = "_$0/" ] && d='./'; cd "$d.."; pwd)"

# --- 必要なマスターファイルの存在確認 -------------------------------
# 1)駅ナンバーマスター
if [ ! -f "$Homedir/DATA/SNUM2RWSN_MST.TXT" ]; then
  echo "${0##*/}: The master file (SNUM2RWSN_MST.TXT) is not found." 2>&1
  exit 1
fi
# 2)各種ボキャブラリーマスター
if [ ! -f "$Homedir/DATA/METRO_VOC_MST.TXT" ]; then
  echo "${0##*/}: The master file (SNUM2RWSN_MST.TXT) is not found." 2>&1
  exit 1
fi

# --- 与えられたアクセストークンを設定 -------------------------------
File_token=$Homedir/CONF/ACCESSTOKEN.TXT
if [ ! -f "$File_token" ]; then
  echo "${0##*/}: The file contains access token is not found." 2>&1
  exit 1
fi
appid=$(env - awk '/^[[:alnum:]]+$/' "$File_token")
if [ -z "$appid" ]; then
  echo "${0##*/}: The access token is not invalid." 2>&1
  exit 1
fi

# --- その他定義 -----------------------------------------------------
# 1)コマンドパスの追加
PATH="$Homedir/UTL:$Homedir/TOOL:$PATH"
# 2)一時ファイル格納先
Tmp=/tmp/${0##*/}.$$
# 3)終了時の一時ファイル削除設定
exit_trap() { rm -f $Tmp-*; }
trap "exit_trap" EXIT HUP INT QUIT PIPE ALRM TERM


######################################################################
# 引数確認・取得
######################################################################

# --- 書式の正当性確認 -----------------------------------------------
[ $# -eq 2 ] || print_usage_and_exit
echo "_$1" | grep -iq '^_[A-Z][0-9][0-9]$' || print_usage_and_exit
echo "_$2" | grep -iq '^_[A-Z][0-9][0-9]$' || print_usage_and_exit

# --- 駅ナンバーの存在確認 -------------------------------------------
printf '%s\n%s\n' $1 $2                          |
sort                                             |
join -1 1 -2 1 $Homedir/DATA/SNUM2RWSN_MST.TXT - |
awk '{print} END{exit (NR==2)?0:1}'              > $Tmp-2stns
if [ $? -ne 0 ]; then
  echo "${0##*/}: 存在しない駅ナンバーが指定されています。"
  exit 1
fi

# --- 同一路線の駅ナンバーであることの確認 ---------------------------
cat $Tmp-2stns              |
sed 's/^\(.\).*/\1/'        |
tr a-z A-Z                  |
uniq                        |
awk 'END{exit (NR==1)?0:1}'
if [ $? -ne 0 ]; then
  echo "${0##*/}: 異なる路線の駅ナンバーは指定できません。"
  exit 1
fi

# --- 駅ナンバー変数をセット -----------------------------------------
from_snum=$1
to_snum=$2


######################################################################
# API呼び出し準備(路線コードと方面コードの決定)
######################################################################

# --- 当該路線駅マンバーマスターファイルの作成 -----------------------
cat $Homedir/DATA/SNUM2RWSN_MST.TXT                |
# 1:駅ナンバー 2:路線コード 3:路線名 4:路線駅コード 5:駅名 6:方面駅コード
grep -i "^${from_snum%[0-9][0-9]}"                 | # 指定路線のみに絞り込む
tee $Tmp-this-rw-stn-mst                           | # 指定路線の路線駅マスター
awk '$6!="-"'                                      > $Tmp-dirstns # 方面駅コードを持つ駅のみに絞り込む

# --- 路線コードの取得 -----------------------------------------------
rwcode=$(awk '{print $2;exit;}' $Tmp-dirstns)

# --- 方面コード群の取得 ---------------------------------------------
dircodes=$(cat $Tmp-dirstns                                             |
           if   [ ${to_snum#[A-Za-z]} -gt ${from_snum#[A-Za-z]} ]; then #
             awk 'substr($1,2,2)*1>'${from_snum#[A-Za-z]}'*1{print $6}' #
           elif [ ${to_snum#[A-Za-z]} -lt ${from_snum#[A-Za-z]} ]; then #
             awk 'substr($1,2,2)*1<'${from_snum#[A-Za-z]}'*1{print $6}' #
           else                                                         #
             awk '$1=="'$to_snum'"{print $6}'                           #
           fi                                                           |
           tr '\n' '|'                                                  |
           sed 's/\./\\./g'                                             |
           sed 's/^\(.\)/(\1/'                                          |
           sed 's/|$/)/'                                                )
if [ ${#dircodes} -le 2 ]; then
  echo "${0##*/}: 方面が特定できません。同じ駅ナンバーを指定していませんか?"
  exit 1
fi


######################################################################
# API呼び出し(列車ロケーション情報の取得)およびデータ加工
######################################################################

# --- 呼び出しURLの設定 ----------------------------------------------
url='https://api.tokyometroapp.jp/api/v2/datapoints?rdf:type=odpt:Train&odpt:railway='$rwcode'&acl:consumerKey='$appid

# --- 呼び出して、必要な情報のみに絞り込んだマスターファイルを作る ---
curl -s $url                                                            |
parsrj.sh                                                               |
sed 's/^\$\[\([0-9]\{1,\}\)\]\.[^:]\{1,\}:/\1 /'                        |
awk '$2=="railDirection"  {$2=1;print;}                                 #
     $2=="fromStation"    {$2=2;print;}                                 #
     $2=="toStation"      {$2=3;print;}                                 #
     $2=="trainType"      {$2=4;print;}                                 #
     $2=="terminalStation"{$2=5;print;}                                 #
     $2=="trainOwner"     {$2=6;print;}'                                |
sort -k1n,2n                                                            |
awk '{print $3}'                                                        |
awk 'NR%6!=0{printf("%s ",$0)} NR%6==0{print $0}'                       |
# 1:方面コード 2:発車駅コード 3:到着駅コード 4:種別コード 5:目的駅コード 6:車両所有業者コード
awk '$1~/^'"$dircodes"'$/{print $2,$3,$4,$5,$6}'                        > $Tmp-this-rw-dir-loc
# 1:発車駅コード 2:到着駅コード 3:種別コード 4:目的駅コード 5:車両所有業者コード

# --- 駅コードから駅ナンバーを引くマスターファイルを作る -------------
cat $Homedir/DATA/SNUM2RWSN_MST.TXT |
# 1:駅ナンバー 2:路線コード 3:路線名 4:路線駅コード 5:駅名 6:方面駅コード
awk '{print $4,$1}'                 |
# 1:路線駅コード 2:駅ナンバー       #
sort -k1,1                          > $Tmp-sc2snum

# --- 列車存在位置から列車名を引くマスターファイルを作る -------------
cat $Tmp-this-rw-dir-loc                                                     |
# 1:発車駅コード 2:到着駅コード 3:種別コード 4:目的駅コード 5:車両所有業者コード
sort -k1,1                                                                   |
join -1 1 -2 1 -o 2.1,1.2,2.2,2.3,2.4,2.5,2.6 $Tmp-sc2snum -                 |
# 1:発車駅コード 2:発車駅ナンバー 3:到着駅コード 4:種別コード 5:目的駅コード 6:車両所有業者コード
awk '{print $2,$3,$4,$5,$6}'                                                 |
# 1:発車駅ナンバー 2:到着駅コード 3:種別コード 4:目的駅コード 5:車両所有業者コード
sort -k2,2                                                                   |
join -1 1 -2 2 -a 2 -o 2.1,2.2,1.2,2.3,2.4,2.5 $Tmp-sc2snum -                |
sed 's/  / - /'                                                              |
# 1:発車駅ナンバー 2:到着駅コード 3:到着駅ナンバー(無い場合は"-") 4:種別コード 5:目的駅コード 6:車両所有業者コード
awk '{print $1,$3,$4,$5,$6}'                                                 |
# 1:発車駅ナンバー 2:到着駅ナンバー(無い場合は"-") 3:種別コード 4:目的駅コード 5:車両所有業者コード
awk '$2=="-"{snumex = $1 "0";                                     }          #
     $2!="-"{rwletter=substr($1,1,1);                                        #
             from = substr($1,2,2)*10;                                       #
             to   = substr($2,2,2)*10;                                       #
             snumex = sprintf("%s%03d",rwletter,from+(to-from)/2);}          #
     {print snumex,$3,$4,$5;                                      }'         |
# 1:現在居る3桁駅ナンバー(3桁目は0または5で、5は中間にいることを表す) 2:種別コード 3:目的駅コード 4:車両所有業者コード
sort -k2,2                                                                   |
join -1 1 -2 2 -a 2 -o 2.1,2.2,1.2,2.3,2.4 $Homedir/DATA/METRO_VOC_MST.TXT - |
sed 's/  / - /'                                                              |
awk '{print $1,$3,$4,$5}'                                                    |
# 1::現在居る3桁駅ナンバー(3桁目は0または5で、5は中間にいることを表す) 2:種別名 3:目的駅コード 4:車両所有業者コード
sort -k3,3                                                                   |
join -1 1 -2 3 -a 2 -o 2.1,2.2,2.3,1.2,2.4 $Homedir/DATA/METRO_VOC_MST.TXT - |
sed 's/  / - /'                                                              |
awk '{print $1,$2,$4,$5}'                                                    |
# 1:現在居る3桁駅ナンバー(3桁目は0または5で、5は中間にいることを表す) 2:種別名 3:目的駅名 4:車両所有業者コード
sort -k4,4                                                                   |
join -1 1 -2 4 -a 2 -o 2.1,2.2,2.3,2.4,1.2 $Homedir/DATA/METRO_VOC_MST.TXT - |
sed 's/  / - /'                                                              |
awk '{print $1,$2,$3,$5}'                                                    |
# 1:現在居る3桁駅ナンバー(3桁目は0または5で、5は中間にいることを表す) 2:種別名 3:目的駅名 4:車両所有業者名
sort -k1,1                                                                   > $Tmp-this-rw-loc


######################################################################
# 最終出力の作成
######################################################################

# --- 駅間を含む3駅ナンバーから駅名を得るマスターファイルを作る ------
#
cat $Tmp-this-rw-stn-mst                                                  |
# 1:駅ナンバー 2:路線コード 3:路線名 4:路線駅コード 5:駅名 6:方面駅コード #
sort -k1,1                                                                |
awk '{print $1,$5}'                                                       |
# 1:駅ナンバー 2:駅名                                                     #
awk '{rwletter = substr($1,1,1);    # 路線アルファベット                  # # 駅間の行を生成する
      n3       = substr($1,2,2)*10; # 3桁駅ナンバーの数字部分             #
      print sprintf("%s%03d",rwletter,n3  ),$2;                           #
      print sprintf("%s%03d",rwletter,n3+5),"-";             }'           |
sed '$d'                                                                  > $Tmp-snumex2sn # 最後の1行は中間ではないので消す
# 1:3桁駅ナンバー 2:駅名(中間の場合は-)

# --- 最終出力を作る -------------------------------------------------
#
join -1 1 -2 1 -a 2 -o 2.1,1.2,1.3,1.4,2.2 $Tmp-this-rw-loc $Tmp-snumex2sn |
sed 's/  / - /g'                                                           |
sed 's/  / - /'                                                            |
# 1:3桁駅ナンバー 2:種別名(居ない時は"-") 3:目的駅名(居ない時は"-") 4:車両所有業者名(居ない時は"-") 5:駅名(中間の場合は"-")
awk '{print $1,$5,$2,$3,$4}'                                               |
# 1:3桁駅ナンバー 2:駅名(中間の場合は"-") 3:種別名 4:目的駅名 5:車両所有業者名
if [ "0${to_snum#[A-Za-z]}" -ge "0${from_snum#[A-Za-z]}" ]; then           # # 駅ナンバー順と反対方面だったら
  cat                                                                      # # 順序を入れ替える。
else                                                                       #
  sort -k1r,1                                                              #
fi                                                                         |
awk '{snum=(match($1,/0$/))?substr($1,1,3):"|"; print snum,$2,$3,$4,$5;}'  | # 駅ナンバーを元に戻す(駅間の場合は"|"にする)
# 1:駅ナンバー(駅間の場合は"|") 2:駅名(駅間の場合は"-") 3:種別名 4:目的駅名 5:車両所有業者名
awk '{idx=($1=="'"$from_snum"'")?">>":".."; print idx,$0;}'                | # 指定駅の行だったら先頭に">>"を付ける
# 1:自位置インデックス 2:駅ナンバー(駅間の場合は"|") 3:駅名(駅間の場合は"-") 4:種別名 5:目的駅名 6:車両所有業者名
awk '$5!="-"{$5=$5 "行";       }                                           # # 接尾辞を付ける
     $6!="-"{$6="(" $6 "車両)";}                                           #
     {print;                   }'                                          |
keta --                                                                    | # 左揃えにする
tr '-' ' '                                                                 | # - はnullを意味するので空白にする
sed 's/[[:blank:]]\{1,\}-//g'                                              | # 行末の不要な"-"をトル
sed 's/[[:blank:]]\{1,\}$//g'                                                # 行末の不要な"-"をトル


######################################################################
# 正常終了
######################################################################

exit 0